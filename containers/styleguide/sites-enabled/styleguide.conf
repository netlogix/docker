server {
    listen 80 default_server;

    root /var/www;

    location / {
        try_files $uri $uri/ /index.html =404;
    }

    location ~ ^/(branches|releases)/[^/]+/scripts?/.*\.js$ {
        # For some reason Chrome does not send Authorization headers for these files. As we are unable to get Chrome to do the
        # right thing, we just disable basic auth. If at one point Chrome is fixed, basic auth can be enabled again.
        auth_basic off;
        allow all;
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Credentials' 'true';
        proxy_pass http://styleguide;
    }

    location ~ "\.(ttf|woff2?|eot|svg|css|json)$" {
        auth_basic off;
        allow all;
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Credentials' 'true';
        proxy_pass http://styleguide;
    }

     location /releases {

        allow 0.0.0.0/32;
        deny all;

         location ~ ^/releases/[^/]+/fonts/.*\.(ttf|woff2?|eot|svg)$ {
             allow all;
             add_header 'Access-Control-Allow-Origin' '*';
         }
         # We need Access-Control-Allow-Origin header on JS files for dynamic es module import
         # https://github.com/tc39/proposal-dynamic-import
         location ~ ^/releases/[^/]+/scripts?/.*\.(js|css)$ {
             allow all;
             add_header 'Access-Control-Allow-Origin' '*';
         }
         location ~ ^/releases/[^/]+/images/(?:.*/)?manifest\.json$ {
             allow all;
             add_header 'Access-Control-Allow-Origin' '*';
         }
         location ~ ^/releases/[^/]+/(?:css/[^/]+\.css|js/.*|images/(?!sample/).*)(?<!\.map)$ {
             allow all;
         }
     }
}
