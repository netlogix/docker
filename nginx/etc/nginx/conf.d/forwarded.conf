map $http_x_forwarded_for $forwarded_remote_addr {
    default $remote_addr;
    ~. $http_x_forwarded_for;
}

map $http_x_forwarded_port $forwarded_port {
    default $server_port;
    ~. $http_x_forwarded_port;
}

map $http_x_real_ip $forwarded_real_ip {
    default $forwarded_remote_addr;
    ~. $http_x_real_ip;
}
